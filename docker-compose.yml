services:
  # Cloudflare Worker - Database API
  db-api:
    image: node:20
    working_dir: /app
    ports:
      - "8787:8787"
    volumes:
      - ./workers/db-api:/app
      - db-api-node-modules:/app/node_modules
    command: sh -c "npm install && npx wrangler dev --port 8787 --ip 0.0.0.0"

  # .NET Server
  server:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    working_dir: /app
    ports:
      - "5165:5165"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5165
      DB_API_URL: http://db-api:8787
      DB_API_TOKEN: dev-token
      METRICS_ENDPOINT: http://metrics-ingest:8788/ingest
      METRICS_TOKEN: dev-token
    volumes:
      - ./server:/app/server
      - ./server.core:/app/server.core
    depends_on:
      - db-api
    command: dotnet watch --project /app/server/server.csproj

  # React/Vite Client
  client:
    image: node:20
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://localhost:5165}
    volumes:
      - ./client:/app
      - client-node-modules:/app/node_modules
    depends_on:
      - server
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"

volumes:
  storage_data:
  db-api-node-modules:
  client-node-modules:

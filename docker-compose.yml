services:
  # Cloudflare Worker - Database API
  db-api:
    image: node:20
    working_dir: /app
    restart: unless-stopped
    ports:
      - "8787:8787"
    volumes:
      - ./workers/db-api:/app
      - db-api-node-modules:/app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8787/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    command: sh /app/docker-init.sh

  # .NET Server
  server:
    image: mcr.microsoft.com/dotnet/sdk:8.0
    working_dir: /app
    restart: unless-stopped
    ports:
      - "5165:5165"
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:5165
      DB_API_URL: http://db-api:8787
      # NOTE: This dev token is for local development only and must not be used in production.
      # Use environment variables or secrets management in production.
      DB_API_TOKEN: dev-token
      # Metrics are optional - uncomment and add metrics-ingest service if needed
      # METRICS_ENDPOINT: http://metrics-ingest:8788/ingest
      # METRICS_TOKEN: dev-token
    volumes:
      - ./server:/app/server
      - ./server.core:/app/server.core
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5165/health/ready || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      db-api:
        condition: service_healthy
    command: dotnet watch --project /app/server/server.csproj

  # React/Vite Client
  client:
    image: node:20
    working_dir: /app
    restart: unless-stopped
    ports:
      - "5173:5173"
    environment:
      VITE_API_URL: ${VITE_API_URL:-http://server:5165}
    volumes:
      - ./client:/app
      - client-node-modules:/app/node_modules
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5173 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    depends_on:
      server:
        condition: service_healthy
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"

volumes:
  db-api-node-modules:
  client-node-modules:
